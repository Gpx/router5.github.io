!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("router5",["exports"],t):t(e.router5=e.router5||{})}(this,function(e){"use strict";function t(e){function t(t){var a=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=!(arguments.length<=2||void 0===arguments[2])&&arguments[2],o=arguments.length<=3||void 0===arguments[3]||arguments[3],u=e.getState();return!!u&&(i||u.name===t?n(e.makeState(t,a),u,o):r(e.makeState(t,a),u))}function n(t,n){var r=arguments.length<=2||void 0===arguments[2]||arguments[2];if(t.name!==n.name)return!1;var a=function(t){return e.rootNode.getSegmentsByName(t).map(function(e){return e.parser[r?"urlParams":"params"]}).reduce(function(e,t){return e.concat(t)},[])},i=a(t.name),o=a(n.name);return i.length===o.length&&i.every(function(e){return t.params[e]===n.params[e]})}function r(e,t){var n=new RegExp("^"+e.name+"\\.(.*)$");return!!n.test(t.name)&&Object.keys(e.params).every(function(n){return e.params[n]===t.params[n]})}function a(t,n){return e.rootNode.buildPath(t,n)}function i(t,n){return e.rootNode.buildState(t,n)}function o(t,n){var r=c.trailingSlash,a=c.strictQueryParams,i=e.rootNode.matchPath(t,{trailingSlash:r,strictQueryParams:a});return i?e.makeState(i.name,i.params,t,i._meta,n):null}function u(t){e.rootNode.setPath(t)}var c=e.getOptions();e.isActive=t,e.areStatesEqual=n,e.areStatesDescendants=r,e.buildPath=a,e.buildState=i,e.matchPath=o,e.setRootPath=u}function n(e){function t(){return a}function n(){var t=arguments.length<=arguments.length-1+0?void 0:arguments[arguments.length-1+0],n="function"==typeof t?t:F,r="function"!=typeof(arguments.length<=0?void 0:arguments[0])?arguments.length<=0?void 0:arguments[0]:void 0;if(a)return n({code:L.ROUTER_ALREADY_STARTED}),e;var o=void 0,u=void 0;a=!0,e.invokeEventListeners($.ROUTER_START);var c=function(t,r){var a=arguments.length<=2||void 0===arguments[2]||arguments[2];t||e.invokeEventListeners($.TRANSITION_SUCCESS,r,null,{replace:!0}),t&&a&&e.invokeEventListeners($.TRANSITION_ERROR,r,null,t),n(t,r)};return void 0!==r||i.defaultRoute?("string"==typeof r?o=r:"object"===("undefined"==typeof r?"undefined":g.typeof(r))&&(u=r),u?(e.setState(u),n(null,u)):!function(){u=void 0===o?null:e.matchPath(o);var t=function(){return e.navigateToDefault({replace:!0},n)},r=function(t){return e.navigate(t.name,t.params,{replace:!0,reload:!0},n)};u?e.transitionToState(u,e.getState(),{},function(e,n){e?e.redirect?r(e.redirect):i.defaultRoute?t():c(e,null,!1):c(null,n)}):i.defaultRoute?t():i.allowNotFound?c(null,e.makeNotFoundState(o)):c({code:L.ROUTE_NOT_FOUND,path:o},null)}(),e):c({code:L.NO_START_PATH_OR_STATE})}function r(){return a&&(e.setState(null),a=!1,e.invokeEventListeners($.ROUTER_STOP)),e}var a=!1,i=e.getOptions();e.isStarted=t,e.start=n,e.stop=r}function r(e){return e.split(".").reduce(function(e,t){return e.concat(e.length?e[e.length-1]+"."+t:t)},[])}function a(e){return void 0!==e&&null!==e}function i(e){return e&&e.meta&&e.meta.params}function o(e,t){return a(t.meta.params[e])?Object.keys(t.meta.params[e]).reduce(function(e,n){return e[n]=t.params[n],e},{}):{}}function u(e,t){function n(){var n=void 0,r=function(){var r=a[n],i=u[n];if(r!==i)return{v:n};var c=o(r,e),s=o(i,t);if(c.length!==s.length)return{v:n};if(0===c.length)return"continue";var l=Object.keys(c).some(function(e){return s[e]!==c[e]});return l?{v:n}:void 0};for(n=0;n<c;n+=1){var i=r();switch(i){case"continue":continue;default:if("object"===("undefined"==typeof i?"undefined":g.typeof(i)))return i.v}}return n}var a=t?r(t.name):[],u=r(e.name),c=Math.min(a.length,u.length),s=void 0;t?i(t)||i(e)?s=n():(console.warn("[router5.transition-path] Some states are missing metadata, reloading all segments"),s=0):s=0;var l=a.slice(s).reverse(),f=u.slice(s),d=t&&s>0?a[s-1]:"";return{intersection:d,toDeactivate:l,toActivate:f}}function c(e,t,n){var r=t.isCancelled,a=t.toState,i=t.fromState,o=t.errorKey,u=Array.isArray(e)?e:Object.keys(e),c=function(e){return"object"===("undefined"==typeof e?"undefined":g.typeof(e))&&void 0!==e.name&&void 0!==e.params&&void 0!==e.path},s=function(e){return e.name!==a.name||e.params!==a.params||e.path!==a.path},l=function(t){if(!u.length)return!0;var n="string"==typeof u[0],c=o&&n?g.defineProperty({},o,u[0]):{},s=n?e[u[0]]:u[0],l=s.call(null,a,i,t);return r()?t(null):"boolean"==typeof l?t(l?null:c):l&&"function"==typeof l.then&&l.then(function(e){e instanceof Error?t({error:e},null):t(null,e)},function(e){e instanceof Error?(console.error(e.stack||e),t(g.extends({},c,{promiseError:e}),null)):t("object"===("undefined"==typeof e?"undefined":g.typeof(e))?g.extends({},c,e):c,null)}),!1},f=function(e,t){r()?n():e?n(e):(t&&c(t)&&(s(t)&&console.error("[router5][transition] Warning: state values changed during transition process."),a=t),u=u.slice(1),d())},d=function(){if(r())n();else{var e=l(f);e&&n(null,a)}};d()}function s(e,t,n,a,i){var o=!1,s=!1,l=e.getOptions(),f=e.getLifecycleFunctions(),d=g.slicedToArray(f,2),h=d[0],v=d[1],p=e.getMiddlewareFunctions(),m=function(){return o},y=function(){o||s||(o=!0,i({code:L.TRANSITION_CANCELLED},null))},T=function(n,a){s=!0,m()||(!n&&l.autoCleanUp&&!function(){var n=r(t.name);Object.keys(h).forEach(function(t){n.indexOf(t)===-1&&e.clearCanDeactivate(t)})}(),i(n,a||t))},S=function(e,t){return g.extends({},e,t instanceof Object?t:{error:t})},A=u(t,n),E=A.toDeactivate,R=A.toActivate,O={isCancelled:m,toState:t,fromState:n},N=function(e,t,n){var r=E.filter(function(e){return h[e]}).reduce(function(e,t){return g.extends({},e,g.defineProperty({},t,h[t]))},{});c(r,g.extends({},O,{errorKey:"segment"}),function(e){return n(e?S({code:L.CANNOT_DEACTIVATE},e):null)})},P=function(e,t,n){var r=R.filter(function(e){return v[e]}).reduce(function(e,t){return g.extends({},e,g.defineProperty({},t,v[t]))},{});c(r,g.extends({},O,{errorKey:"segment"}),function(e){return n(e?S({code:L.CANNOT_ACTIVATE},e):null)})},_=p.length?function(e,t,n){return c(p,g.extends({},O),function(t,r){return n(t?S({code:L.TRANSITION_ERR},t):null,r||e)})}:[],b=(n&&!a.forceDeactivate?[N]:[]).concat(P).concat(_);return c(b,O,T),y}function l(e){function t(){return i&&(i("navigate"),i=null),e}function n(){var t=arguments.length<=0?void 0:arguments[0],r=arguments.length<=arguments.length-1+0?void 0:arguments[arguments.length-1+0],i="function"==typeof r?r:M,o="object"===g.typeof(arguments.length<=1?void 0:arguments[1])?arguments.length<=1?void 0:arguments[1]:{},u="object"===g.typeof(arguments.length<=2?void 0:arguments[2])?arguments.length<=2?void 0:arguments[2]:{};if(!e.isStarted())return void i({code:L.ROUTER_NOT_STARTED});var c=e.buildState(t,o);if(!c){var s={code:L.ROUTE_NOT_FOUND};return i(s),void e.invokeEventListeners($.TRANSITION_ERROR,null,e.getState(),s)}var l=e.makeState(c.name,c.params,e.buildPath(t,o),c._meta),f=!!e.getState()&&e.areStatesEqual(e.getState(),l,!1);if(f&&!u.reload){var d={code:L.SAME_STATES};return i(d),void e.invokeEventListeners($.TRANSITION_ERROR,l,e.getState(),d)}var h=f?null:e.getState();return a(l,h,u,function(t,r){if(t)if(t.redirect){var a=t.redirect,o=a.name,c=a.params;n(o,c,g.extends({},u,{reload:!0}),i)}else i(t);else e.invokeEventListeners($.TRANSITION_SUCCESS,r,h,u),i(null,r)})}function r(){var t="object"===g.typeof(arguments.length<=0?void 0:arguments[0])?arguments.length<=0?void 0:arguments[0]:{},r=2===arguments.length?arguments.length<=1?void 0:arguments[1]:"function"==typeof(arguments.length<=0?void 0:arguments[0])?arguments.length<=0?void 0:arguments[0]:M,a=e.getOptions();return a.defaultRoute?n(a.defaultRoute,a.defaultParams,t,r):function(){}}function a(n,r){var a=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=arguments.length<=3||void 0===arguments[3]?M:arguments[3];return t(),e.invokeEventListeners($.TRANSITION_START,n,r),i=s(e,n,r,a,function(t,a){i=null,a=a||n,t?(t.code===L.TRANSITION_CANCELLED?e.invokeEventListeners($.TRANSITION_CANCELLED,n,r):e.invokeEventListeners($.TRANSITION_ERROR,n,r,t),o(t)):(e.setState(a),o(null,a))})}var i=void 0;e.navigate=n,e.navigateToDefault=r,e.transitionToState=a,e.cancel=t}function f(e){function t(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];return n.forEach(i),e}function n(){return o=[],u=[],e}function r(){return o}function a(){return u}function i(t){o.push(t),u.push(e.executeFactory(t))}var o=[],u=[];e.useMiddleware=t,e.getMiddlewareFactories=r,e.getMiddlewareFunctions=a,e.clearMiddleware=n}function d(e){function t(){return o}function n(){for(var t=arguments.length,n=Array(t),a=0;a<t;a++)n[a]=arguments[a];return n.forEach(r),e}function r(e){a(e)||(o.push(e),i(e))}function a(e){return o.filter(function(t){return t.pluginName===e||t.name===e}).length>0}function i(t){var n=e.executeFactory(t),r=q.map(function(t){if(n[t])return e.addEventListener(t.toLowerCase().replace(/^on/,"$$").replace(/transition/,"$$"),n[t])}).filter(Boolean);u.push.apply(u,g.toConsumableArray(r))}var o=[],u=[];e.usePlugin=n,e.hasPlugin=a,e.getPlugins=t}function h(e){function t(){return[o,u]}function n(){return[c,s]}function r(t,n){var r=B(n);return o[t]=r,c[t]=e.executeFactory(r),e}function a(t){return o[t]=void 0,c[t]=void 0,e}function i(t,n){var r=B(n);return u[t]=r,s[t]=e.executeFactory(r),e}var o={},u={},c={},s={};e.canDeactivate=r,e.canActivate=i,e.getLifecycleFactories=t,e.getLifecycleFunctions=n,e.clearCanDeactivate=a}function v(e,t){function n(){var n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=g.extends({},e.getDependencies(),n),a=t(e.rootNode,e.getOptions(),r);a.useMiddleware.apply(a,g.toConsumableArray(e.getMiddlewareFactories())),a.usePlugin.apply(a,g.toConsumableArray(e.getPlugins()));var i=e.getLifecycleFactories(),o=g.slicedToArray(i,2),u=o[0],c=o[1];return Object.keys(u).forEach(function(e){return a.canDeactivate(e,u[e])}),Object.keys(c).forEach(function(e){return a.canActivate(e,c[e])}),a}e.clone=n}function p(e){function r(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];(C[e]||[]).forEach(function(e){return e.apply(void 0,n)})}function a(e,t){C[e]=C[e].filter(function(e){return e!==t})}function i(e,t){return C[e]=(C[e]||[]).concat(t),function(){return a(e,t)}}function o(e){e.canActivate&&I.canActivate(e.name,e.canActivate)}function u(e,t,n,r,a){var i={},o=function(e,t){return Object.defineProperty(i,e,{value:t,enumerable:!0})};if(o("name",e),o("params",t),o("path",n),r||a){var u={params:r};a&&(u.source=a),o("meta",u)}return i}function c(e){return u($.UNKNOWN_ROUTE,{path:e},e,{})}function s(){return k}function m(e){k=e}function y(){return w}function T(e,t){return w[e]=t,I}function S(e,t){return x[e]=t,I}function A(e){return Object.keys(e).forEach(function(t){x[t]=e[t]}),I}function E(){return x}function R(){return[I,E()]}function O(e){return e.apply(void 0,g.toConsumableArray(R()))}function N(e){return j.add(e,o),I}function P(e,t,n){return I.rootNode.addNode(e,t),n&&I.canActivate(e,n),I}var _=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],b=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],k=null,C={},x=b,w=g.extends({},z,_),I={rootNode:j,getOptions:y,setOption:T,getState:s,setState:m,makeState:u,makeNotFoundState:c,setDependency:S,setDependencies:A,getDependencies:E,add:N,addNode:P,executeFactory:O,addEventListener:i,removeEventListener:a,invokeEventListeners:r};t(I),d(I),f(I),h(I),n(I),l(I),v(I,p);var j=e instanceof D?e:new D("","",e,o);return I.rootNode=j,I}function m(){var e=function(){return console.group("Router transition")},t=function(){return console.groupEnd("Router transition")};return console.info("Router started"),{onStop:function(){console.info("Router stopped")},onTransitionStart:function(n,r){t(),e(),console.log("Transition started from state"),console.log(r),console.log("To state"),console.log(n)},onTransitionCancel:function(){console.warn("Transition cancelled")},onTransitionError:function(e,n,r){console.warn("Transition error with code "+r.code),t()},onTransitionSuccess:function(){console.log("Transition success"),t()}}}var g={};g.typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},g.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},g.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),g.defineProperty=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},g.extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},g.slicedToArray=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var o,u=e[Symbol.iterator]();!(r=(o=u.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{!r&&u.return&&u.return()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),g.toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)};var y=function(e){return"("+(e?e.replace(/(^<|>$)/g,""):"[a-zA-Z0-9-_.~%]+")+")"},T=[{name:"url-parameter",pattern:/^:([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(e){return new RegExp(y(e[2]))}},{name:"url-parameter-splat",pattern:/^\*([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/,regex:/([^\?]*)/},{name:"url-parameter-matrix",pattern:/^\;([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(e){return new RegExp(";"+e[1]+"="+y(e[2]))}},{name:"query-parameter-bracket",pattern:/^(?:\?|&)(?:\:)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(?:\[\])/},{name:"query-parameter",pattern:/^(?:\?|&)(?:\:)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/},{name:"delimiter",pattern:/^(\/|\?)/,regex:function(e){return new RegExp("\\"+e[0])}},{name:"sub-delimiter",pattern:/^(\!|\&|\-|_|\.|;)/,regex:function(e){return new RegExp(e[0])}},{name:"fragment",pattern:/^([0-9a-zA-Z]+)/,regex:function(e){return new RegExp(e[0])}}],S=function e(t){var n=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],r=T.some(function(r){var a=t.match(r.pattern);return!!a&&(n.push({type:r.name,match:a[0],val:a.slice(1,2),otherVal:a.slice(2),regex:r.regex instanceof Function?r.regex(a):r.regex}),a[0].length<t.length&&(n=e(t.substr(a[0].length),n)),!0)});if(!r)throw new Error("Could not parse path.");return n},A=function(e,t){return t?e.replace(/\\\/$/,"")+"(?:\\/)?":e},E=function(e){return e.replace(/\[\]$/,"")},R=function(e,t){var n=arguments.length<=2||void 0===arguments[2]?"":arguments[2];/\[\]$/.test(t)&&(t=E(t),n=[n]);var r=e[t];return void 0===r?e[t]=n:e[t]=Array.isArray(r)?r.concat(n):[r,n],e},O=function(e){var t=e.split("?")[1];return t?t.split("&").map(function(e){return e.split("=")}).reduce(function(e,t){return R(e,t[0],t[1]?decodeURIComponent(t[1]):t[1])},{}):{}},N=function(e){return void 0!==e&&null!==e&&""!==e?"="+e:""},P=function e(t,n){return Array.isArray(n)?n.map(function(n){return e(t,n)}).join("&"):t+N(n)},_=function(){function e(t){if(g.classCallCheck(this,e),!t)throw new Error("Please supply a path");this.path=t,this.tokens=S(t),this.hasUrlParams=this.tokens.filter(function(e){return/^url-parameter/.test(e.type)}).length>0,this.hasSpatParam=this.tokens.filter(function(e){return/splat$/.test(e.type)}).length>0,this.hasMatrixParams=this.tokens.filter(function(e){return/matrix$/.test(e.type)}).length>0,this.hasQueryParams=this.tokens.filter(function(e){return/^query-parameter/.test(e.type)}).length>0,this.urlParams=this.hasUrlParams?this.tokens.filter(function(e){return/^url-parameter/.test(e.type)}).map(function(e){return e.val.slice(0,1)}).reduce(function(e,t){return e.concat(t)}):[],this.queryParams=this.hasQueryParams?this.tokens.filter(function(e){return"query-parameter"===e.type}).map(function(e){return e.val}).reduce(function(e,t){return e.concat(t)},[]):[],this.queryParamsBr=this.hasQueryParams?this.tokens.filter(function(e){return/-bracket$/.test(e.type)}).map(function(e){return e.val}).reduce(function(e,t){return e.concat(t)},[]):[],this.params=this.urlParams.concat(this.queryParams).concat(this.queryParamsBr),this.source=this.tokens.filter(function(e){return void 0!==e.regex}).map(function(e){return e.regex.source}).join("")}return g.createClass(e,null,[{key:"createPath",value:function(t){return new e(t)}},{key:"serialise",value:function(e,t){return P(e,t)}}]),g.createClass(e,[{key:"_urlMatch",value:function(e,t){var n=this,r=e.match(t);return r?this.urlParams.length?r.slice(1,this.urlParams.length+1).reduce(function(e,t,r){return e[n.urlParams[r]]=decodeURIComponent(t),e},{}):{}:null}},{key:"match",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?0:arguments[1],r=A(this.source,n),a=this._urlMatch(e,new RegExp("^"+r+(this.hasQueryParams?"(\\?.*$|$)":"$")));if(!a||!this.hasQueryParams)return a;var i=O(e),o=Object.keys(i).filter(function(e){return t.queryParams.concat(t.queryParamsBr).indexOf(e)===-1});return 0===o.length?(Object.keys(i).forEach(function(e){return a[e]=i[e]}),a):null}},{key:"partialMatch",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?0:arguments[1],r=A(this.source,n),a=this._urlMatch(e,new RegExp("^"+r));if(!a)return a;if(!this.hasQueryParams)return a;var i=O(e);return Object.keys(i).filter(function(e){return t.queryParams.concat(t.queryParamsBr).indexOf(e)>=0}).forEach(function(e){return R(a,e,i[e])}),a}},{key:"build",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{ignoreConstraints:!1,ignoreSearch:!1}:arguments[1],n=Object.keys(e).reduce(function(t,n){return void 0===e[n]?t[n]=void 0:t[n]=Array.isArray(e[n])?e[n].map(encodeURI):encodeURI(e[n]),t},{});if(this.urlParams.some(function(t){return void 0===e[t]}))throw new Error("Missing parameters");if(!t.ignoreConstraints){var r=this.tokens.filter(function(e){return/^url-parameter/.test(e.type)&&!/-splat$/.test(e.type)}).every(function(e){return new RegExp("^"+y(e.otherVal[0])+"$").test(n[e.val])});if(!r)throw new Error("Some parameters are of invalid format")}var a=this.tokens.filter(function(e){return/^query-parameter/.test(e.type)===!1}).map(function(e){return"url-parameter-matrix"===e.type?";"+e.val+"="+n[e.val[0]]:/^url-parameter/.test(e.type)?n[e.val[0]]:e.match}).join("");if(t.ignoreSearch)return a;var i=this.queryParams.concat(this.queryParamsBr.map(function(e){return e+"[]"})),o=i.filter(function(e){return Object.keys(n).indexOf(E(e))!==-1}).map(function(e){return P(e,n[E(e)])}).join("&");return a+(o?"?"+o:"")}}]),e}(),b=function(e){return e.split("?")[0]},k=function(e){return e.split("?")[1]},C=/\[\]$/,x=function(e){return e.replace(C,"")},w=function(e){return e.split("&").reduce(function(e,t){var n=t.split("="),r=n[0],a=n[1];return e.concat(1===n.length?{name:r,value:!0}:{name:r,value:decodeURIComponent(a)})},[])},I=function(e){return e.filter(function(e){var t=e.value;return void 0!==t&&null!==t}).map(function(e){var t=e.name,n=e.value;return n===!0?t:t+"="+encodeURIComponent(n)}).join("&")},j=function(e,t){if(!e)return"";var n=w(e).filter(function(e){var n=e.name;return t.indexOf(x(n))===-1}),r=I(n);return r||""},U=function(){},D=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?"":arguments[0],n=arguments.length<=1||void 0===arguments[1]?"":arguments[1],r=arguments.length<=2||void 0===arguments[2]?[]:arguments[2],a=arguments[3];return g.classCallCheck(this,e),this.name=t,this.path=n,this.parser=n?new _(n):null,this.children=[],this.add(r,a),this}return g.createClass(e,[{key:"setPath",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];this.path=e,this.parser=e?new _(e):null}},{key:"add",value:function(t){var n=this,r=arguments.length<=1||void 0===arguments[1]?U:arguments[1],a=void 0;if(void 0!==t&&null!==t){if(t instanceof Array)return void t.forEach(function(e){return n.add(e,r)});if(!(t instanceof e||t instanceof Object))throw new Error("RouteNode.add() expects routes to be an Object or an instance of RouteNode.");if(t instanceof Object){if(!t.name||!t.path)throw new Error("RouteNode.add() expects routes to have a name and a path defined.");a=t,t=new e(t.name,t.path,t.children,r)}var i=t.name.split(".");if(1===i.length){if(this.children.map(function(e){return e.name}).indexOf(t.name)!==-1)throw new Error('Alias "'+t.name+'" is already defined in route node');if(this.children.map(function(e){return e.path}).indexOf(t.path)!==-1)throw new Error('Path "'+t.path+'" is already defined in route node');this.children.push(t),this.children.sort(function(e,t){var n=e.path.split("?")[0].replace(/(.+)\/$/,"$1"),r=t.path.split("?")[0].replace(/(.+)\/$/,"$1");if("/"===n)return 1;if("/"===r)return-1;if(e.parser.hasSpatParam)return 1;if(t.parser.hasSpatParam)return-1;var a=(n.match(/\//g)||[]).length,i=(r.match(/\//g)||[]).length;if(a<i)return 1;if(a>i)return-1;var o=e.parser.urlParams.length,u=t.parser.urlParams.length;if(o<u)return-1;if(o>u)return 1;var c=(n.split("/").slice(-1)[0]||"").length,s=(r.split("/").slice(-1)[0]||"").length;return c<s?1:c>s?-1:0})}else{var o=this.getSegmentsByName(i.slice(0,-1).join("."));if(!o)throw new Error("Could not add route named '"+t.name+"', parent is missing.");o[o.length-1].add(new e(i[i.length-1],t.path,t.children))}return a&&r(a),this}}},{key:"addNode",value:function(t,n){return this.add(new e(t,n)),this}},{key:"getSegmentsByName",value:function(e){var t=function(e,t){var n=t.filter(function(t){return t.name===e});return n.length?n[0]:void 0},n=[],r=this.parser?[this]:this.children,a=(this.parser?[""]:[]).concat(e.split(".")),i=a.every(function(e){var a=t(e,r);return!!a&&(r=a.children,n.push(a),!0)});return i?n:null}},{key:"getSegmentsMatchingPath",value:function(e,t){var n=t.trailingSlash,r=t.strictQueryParams,a=function e(t,a,i){var o=1===t.length&&""===t[0].name,u=function(u){var c=t[u],s=c.parser.partialMatch(a),l=void 0;if(!s&&n)s=c.parser.match(a,!0),l="";else if(s){var f=c.parser.build(s,{ignoreSearch:!0});l=a.replace(f,"");var d=j(k(a.replace(f,"")),c.parser.queryParams.concat(c.parser.queryParamsBr));l=b(l)+(d?"?"+d:""),!n||o||"/"!==l||/\/$/.test(f)||(l="")}if(s){if(i.push(c),Object.keys(s).forEach(function(e){return i.params[e]=s[e]}),!o&&!l.length)return{v:i};if(!o&&!r&&0===l.indexOf("?")){var h=w(l.slice(1));return h.forEach(function(e){var t=e.name,n=e.value;return i.params[t]=n}),{v:i}}return c.children.length?{v:e(c.children,l,i)}:{v:null}}};for(var c in t){var s=u(c);if("object"===("undefined"==typeof s?"undefined":g.typeof(s)))return s.v}return null},i=this.parser?[this]:this.children,o=[];o.params={};var u=a(i,e,o);return u&&1===u.length&&""===u[0].name?null:u}},{key:"getPathFromSegments",value:function(e){return e?e.map(function(e){return e.path}).join(""):null}},{key:"getPath",value:function(e){return this.getPathFromSegments(this.getSegmentsByName(e))}},{key:"buildPathFromSegments",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if(!e)return null;var n=e.filter(function(e){return e.parser.hasQueryParams}).reduce(function(e,t){return e.concat(t.parser.queryParams).concat(t.parser.queryParamsBr.map(function(e){return e+"[]"}))},[]),r=n.length?n.filter(function(e){if(Object.keys(t).indexOf(x(e))===-1)return!1;var n=t[x(e)];return void 0!==n&&null!==n}).map(function(e){var n=t[x(e)],r=Array.isArray(n)?n.map(encodeURIComponent):encodeURIComponent(n);return _.serialise(e,r)}).join("&"):null;return e.map(function(e){return e.parser.build(t,{ignoreSearch:!0})}).join("")+(r?"?"+r:"")}},{key:"getMetaFromSegments",value:function(e){var t="";return e.reduce(function(e,n){var r=n.parser.urlParams.reduce(function(e,t){return e[t]="url",e},{}),a=n.parser.queryParams.reduce(function(e,t){return e[t]="query",e},r);return void 0!==n.name&&(t=t?t+"."+n.name:n.name,e[t]=a),e},{})}},{key:"buildPath",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this.buildPathFromSegments(this.getSegmentsByName(e),t)}},{key:"buildStateFromSegments",value:function(e){if(!e||!e.length)return null;var t=e.map(function(e){return e.name}).filter(function(e){return e}).join("."),n=e.params;return{name:t,params:n,_meta:this.getMetaFromSegments(e)}}},{key:"buildState",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=this.getSegmentsByName(e);return n&&n.length?{name:e,params:t,_meta:this.getMetaFromSegments(n)}:null}},{key:"matchPath",value:function(e,t){var n={trailingSlash:!1,strictQueryParams:!0};return t=g.extends({},n,t),this.buildStateFromSegments(this.getSegmentsMatchingPath(e,t))}}]),e}(),L={ROUTER_NOT_STARTED:"NOT_STARTED",NO_START_PATH_OR_STATE:"NO_START_PATH_OR_STATE",ROUTER_ALREADY_STARTED:"ALREADY_STARTED",ROUTE_NOT_FOUND:"ROUTE_NOT_FOUND",SAME_STATES:"SAME_STATES",CANNOT_DEACTIVATE:"CANNOT_DEACTIVATE",CANNOT_ACTIVATE:"CANNOT_ACTIVATE",TRANSITION_ERR:"TRANSITION_ERR",TRANSITION_CANCELLED:"CANCELLED"},$={UNKNOWN_ROUTE:"@@router5/UNKNOWN_ROUTE",ROUTER_START:"$start",ROUTER_STOP:"$stop",TRANSITION_START:"$$start",TRANSITION_CANCEL:"$$cancel",TRANSITION_SUCCESS:"$$success",TRANSITION_ERROR:"$$error"},F=function(){},M=function(){},q=["onStart","onStop","onTransitionSuccess","onTransitionStart","onTransitionError","onTransitionCancel"],B=function(e){return"function"==typeof e?e:function(){return function(){return e}}},z={trailingSlash:0,autoCleanUp:!0,strictQueryParams:!0,allowNotFound:!1};m.pluginName="LOGGER_PLUGIN",e.default=p,e.createRouter=p,e.RouteNode=D,e.loggerPlugin=m,e.errorCodes=L,e.transitionPath=u,e.constants=$,Object.defineProperty(e,"__esModule",{value:!0})});
(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
    typeof define === 'function' && define.amd ? define('router5BrowserPlugin', factory) :
    (global.router5BrowserPlugin = factory());
}(this, function () { 'use strict';

    var babelHelpers = {};

    babelHelpers.extends = Object.assign || function (target) {
      for (var i = 1; i < arguments.length; i++) {
        var source = arguments[i];

        for (var key in source) {
          if (Object.prototype.hasOwnProperty.call(source, key)) {
            target[key] = source[key];
          }
        }
      }

      return target;
    };

    babelHelpers;

    var errorCodes = {
        ROUTER_NOT_STARTED: 'NOT_STARTED',
        NO_START_PATH_OR_STATE: 'NO_START_PATH_OR_STATE',
        ROUTER_ALREADY_STARTED: 'ALREADY_STARTED',
        ROUTE_NOT_FOUND: 'ROUTE_NOT_FOUND',
        SAME_STATES: 'SAME_STATES',
        CANNOT_DEACTIVATE: 'CANNOT_DEACTIVATE',
        CANNOT_ACTIVATE: 'CANNOT_ACTIVATE',
        TRANSITION_ERR: 'TRANSITION_ERR',
        TRANSITION_CANCELLED: 'CANCELLED'
    };

    var constants = {
        UNKNOWN_ROUTE: '@@router5/UNKNOWN_ROUTE',
        ROUTER_START: '$start',
        ROUTER_STOP: '$stop',
        TRANSITION_START: '$$start',
        TRANSITION_CANCEL: '$$cancel',
        TRANSITION_SUCCESS: '$$success',
        TRANSITION_ERROR: '$$error'
    };

    /**
     * Dumb functions
     */
    // istanbul ignore next
    var identity = function identity(arg) {
        return function () {
            return arg;
        };
    };
    // istanbul ignore next
    var noop = function noop() {};

    /**
     * Browser detection
     */
    var isBrowser = typeof window !== 'undefined' && window.history;

    /**
     * Browser functions needed by router5
     */
    var getBase = function getBase() {
        return window.location.pathname.replace(/\/$/, '');
    };

    var pushState = function pushState(state, title, path) {
        return window.history.pushState(state, title, path);
    };

    var replaceState = function replaceState(state, title, path) {
        return window.history.replaceState(state, title, path);
    };

    var addPopstateListener = function addPopstateListener(fn) {
        return window.addEventListener('popstate', fn);
    };

    var removePopstateListener = function removePopstateListener(fn) {
        return window.removeEventListener('popstate', fn);
    };

    var getLocation = function getLocation(opts) {
        var path = opts.useHash ? window.location.hash.replace(new RegExp('^#' + opts.hashPrefix), '') : window.location.pathname.replace(new RegExp('^' + opts.base), '');
        return (path || '/') + window.location.search;
    };

    var getState = function getState() {
        return window.history.state;
    };

    /**
     * Export browser object
     */
    var browser = {};
    if (isBrowser) {
        browser = { getBase: getBase, pushState: pushState, replaceState: replaceState, addPopstateListener: addPopstateListener, removePopstateListener: removePopstateListener, getLocation: getLocation, getState: getState };
    } else {
        // istanbul ignore next
        browser = {
            getBase: identity(''),
            pushState: noop,
            replaceState: noop,
            addPopstateListener: noop,
            removePopstateListener: noop,
            getLocation: identity(''),
            getState: identity(null)
        };
    }

    var safeBrowser = browser;

    function withUtils(router, options) {
        router.urlToPath = urlToPath;
        router.buildUrl = buildUrl;
        router.matchUrl = matchUrl;

        function buildUrl(route, params) {
            return (options.base || '') + (options.useHash ? '#' + options.hashPrefix : '') + router.buildPath(route, params);
        }

        function urlToPath(url) {
            var match = url.match(/^(?:http|https)\:\/\/(?:[0-9a-z_\-\.\:]+?)(?=\/)(.*)$/);
            var path = match ? match[1] : url;

            var pathParts = path.match(/^(.+?)(#.+?)?(\?.+)?$/);

            if (!pathParts) throw new Error('[router5] Could not parse url ' + url);

            var pathname = pathParts[1];
            var hash = pathParts[2] || '';
            var search = pathParts[3] || '';

            return (options.useHash ? hash.replace(new RegExp('^#' + options.hashPrefix), '') : options.base ? pathname.replace(new RegExp('^' + options.base), '') : pathname) + search;
        }

        function matchUrl(url) {
            return router.matchPath(urlToPath(url));
        }
    }

    var defaultOptions = {
        forceDeactivate: true,
        useHash: false,
        hashPrefix: '',
        base: false
    };

    var source = 'popstate';

    function browserPluginFactory() {
        var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
        var browser = arguments.length <= 1 || arguments[1] === undefined ? safeBrowser : arguments[1];

        var options = babelHelpers.extends({}, defaultOptions, opts);
        var transitionOptions = { forceDeactivate: options.forceDeactivate, source: source };

        function browserPlugin(router) {
            var routerOptions = router.getOptions();
            var routerStart = router.start;

            withUtils(router, options);

            router.start = function () {
                for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
                    args[_key] = arguments[_key];
                }

                if (args.length === 0 || typeof args[0] === 'function') {
                    routerStart.apply(undefined, [browser.getLocation(options)].concat(args));
                } else {
                    routerStart.apply(undefined, args);
                }

                return router;
            };

            router.replaceHistoryState = function (name) {
                var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

                var state = router.buildState(name, params);
                var url = router.buildUrl(name, params);
                router.lastKnownState = state;
                browser.replaceState(state, '', url);
            };

            function updateBrowserState(state, url, replace) {
                if (replace) browser.replaceState(state, '', url);else browser.pushState(state, '', url);
            }

            function onPopState(evt) {
                var routerState = router.getState();
                // Do nothing if no state or if last know state is poped state (it should never happen)
                var newState = !evt.state || !evt.state.name;
                var state = newState ? router.matchPath(browser.getLocation(options), source) : evt.state;
                var defaultRoute = routerOptions.defaultRoute;
                var defaultParams = routerOptions.defaultParams;


                if (!state) {
                    // If current state is already the default route, we will have a double entry
                    // Navigating back and forth will emit SAME_STATES error
                    defaultRoute && router.navigateToDefault(babelHelpers.extends({}, transitionOptions, { reload: true, replace: true }));
                    return;
                }
                if (routerState && router.areStatesEqual(state, routerState, false)) {
                    return;
                }

                router.transitionToState(state, routerState, transitionOptions, function (err, toState) {
                    if (err) {
                        if (err.redirect) {
                            var _err$redirect = err.redirect;
                            var name = _err$redirect.name;
                            var params = _err$redirect.params;


                            router.navigate(name, params, babelHelpers.extends({}, transitionOptions, { replace: true }));
                        } else if (err === errorCodes.CANNOT_DEACTIVATE) {
                            var url = router.buildUrl(routerState.name, routerState.params);
                            if (!newState) {
                                // Keep history state unchanged but use current URL
                                updateBrowserState(state, url, true);
                            }
                            // else do nothing or history will be messed up
                            // TODO: history.back()?
                        } else {
                                // Force navigation to default state
                                defaultRoute && router.navigate(defaultRoute, defaultParams, babelHelpers.extends({}, transitionOptions, { reload: true, replace: true }));
                            }
                    } else {
                        router.invokeEventListeners(constants.TRANSITION_SUCCESS, toState, routerState, { replace: true });
                    }
                });
            }

            function onStart() {
                if (options.useHash && !options.base) {
                    // Guess base
                    options.base = browser.getBase();
                }

                browser.addPopstateListener(onPopState);
            }

            function onStop() {
                browser.removePopstateListener(onPopState);
            }

            function onTransitionSuccess(toState, fromState, opts) {
                var historyState = browser.getState();
                var replace = opts.replace || fromState && router.areStatesEqual(toState, fromState, false) || opts.reload && historyState && router.areStatesEqual(toState, historyState, false);
                updateBrowserState(toState, router.buildUrl(toState.name, toState.params), replace);
            }

            return { onStart: onStart, onStop: onStop, onTransitionSuccess: onTransitionSuccess, onPopState: onPopState };
        };

        browserPlugin.pluginName = 'BROWSER_PLUGIN';

        return browserPlugin;
    }

    return browserPluginFactory;

}));
(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
    typeof define === 'function' && define.amd ? define('router5ListenersPlugin', factory) :
    (global.router5ListenersPlugin = factory());
}(this, function () { 'use strict';

    var babelHelpers = {};
    babelHelpers.typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
      return typeof obj;
    } : function (obj) {
      return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj;
    };
    babelHelpers;

    function nameToIDs(name) {
        return name.split('.').reduce(function (ids, name) {
            return ids.concat(ids.length ? ids[ids.length - 1] + '.' + name : name);
        }, []);
    }

    function exists(val) {
        return val !== undefined && val !== null;
    }

    function hasMetaParams(state) {
        return state && state.meta && state.meta.params;
    }

    function extractSegmentParams(name, state) {
        if (!exists(state.meta.params[name])) return {};

        return Object.keys(state.meta.params[name]).reduce(function (params, p) {
            params[p] = state.params[p];
            return params;
        }, {});
    }

    function transitionPath(toState, fromState) {
        var fromStateIds = fromState ? nameToIDs(fromState.name) : [];
        var toStateIds = nameToIDs(toState.name);
        var maxI = Math.min(fromStateIds.length, toStateIds.length);

        function pointOfDifference() {
            var i = void 0;

            var _loop = function _loop() {
                var left = fromStateIds[i];
                var right = toStateIds[i];

                if (left !== right) return {
                        v: i
                    };

                var leftParams = extractSegmentParams(left, toState);
                var rightParams = extractSegmentParams(right, fromState);

                if (leftParams.length !== rightParams.length) return {
                        v: i
                    };
                if (leftParams.length === 0) return 'continue';

                var different = Object.keys(leftParams).some(function (p) {
                    return rightParams[p] !== leftParams[p];
                });
                if (different) {
                    return {
                        v: i
                    };
                }
            };

            for (i = 0; i < maxI; i += 1) {
                var _ret = _loop();

                switch (_ret) {
                    case 'continue':
                        continue;

                    default:
                        if ((typeof _ret === 'undefined' ? 'undefined' : babelHelpers.typeof(_ret)) === "object") return _ret.v;
                }
            }

            return i;
        }

        var i = void 0;
        if (!fromState) {
            i = 0;
        } else if (!hasMetaParams(fromState) && !hasMetaParams(toState)) {
            console.warn('[router5.transition-path] Some states are missing metadata, reloading all segments');
            i = 0;
        } else {
            i = pointOfDifference();
        }

        var toDeactivate = fromStateIds.slice(i).reverse();
        var toActivate = toStateIds.slice(i);

        var intersection = fromState && i > 0 ? fromStateIds[i - 1] : '';

        return {
            intersection: intersection,
            toDeactivate: toDeactivate,
            toActivate: toActivate
        };
    }

    var defaultOptions = {
        autoCleanUp: true
    };

    function listenersPluginFactory() {
        var options = arguments.length <= 0 || arguments[0] === undefined ? defaultOptions : arguments[0];

        function listenersPlugin(router) {
            var listeners = {};

            function removeListener(name, cb) {
                if (cb) {
                    if (listeners[name]) listeners[name] = listeners[name].filter(function (callback) {
                        return callback !== cb;
                    });
                } else {
                    listeners[name] = [];
                }
                return router;
            };

            function addListener(name, cb, replace) {
                var normalizedName = name.replace(/^(\*|\^|=)/, '');

                if (normalizedName && !/^\$/.test(name)) {
                    var segments = router.rootNode.getSegmentsByName(normalizedName);
                    if (!segments) console.warn('No route found for ' + normalizedName + ', listener might never be called!');
                }

                if (!listeners[name]) listeners[name] = [];
                listeners[name] = (replace ? [] : listeners[name]).concat(cb);

                return router;
            };

            router.getListeners = function () {
                return listeners;
            };

            router.addListener = function (cb) {
                return addListener('*', cb);
            };
            router.removeListener = function (cb) {
                return removeListener('*', cb);
            };

            router.addNodeListener = function (name, cb) {
                return addListener('^' + name, cb, true);
            };
            router.removeNodeListener = function (name, cb) {
                return removeListener('^' + name, cb);
            };

            router.addRouteListener = function (name, cb) {
                return addListener('=' + name, cb);
            };
            router.removeRouteListener = function (name, cb) {
                return removeListener('=' + name, cb);
            };

            function invokeListeners(name, toState, fromState) {
                (listeners[name] || []).forEach(function (cb) {
                    if (listeners[name].indexOf(cb) !== -1) {
                        cb(toState, fromState);
                    }
                });
            }

            function onTransitionSuccess(toState, fromState, opts) {
                var _transitionPath = transitionPath(toState, fromState);

                var intersection = _transitionPath.intersection;
                var toDeactivate = _transitionPath.toDeactivate;

                var intersectionNode = opts.reload ? '' : intersection;
                var name = toState.name;


                if (options.autoCleanUp) {
                    toDeactivate.forEach(function (name) {
                        return removeListener('^' + name);
                    });
                }

                invokeListeners('^' + intersectionNode, toState, fromState);
                invokeListeners('=' + name, toState, fromState);
                invokeListeners('*', toState, fromState);
            }

            return { onTransitionSuccess: onTransitionSuccess };
        };

        listenersPlugin.pluginName = 'LISTENERS_PLUGIN';

        return listenersPlugin;
    }

    return listenersPluginFactory;

}));
